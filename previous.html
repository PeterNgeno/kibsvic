<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Recent Constructions ‚Äì KIBSVIC LIMITED</title>
<style>
  body { font-family: Arial; background: #f2f2f2; margin: 0; padding: 0; color: #333; }
  header, footer { background-color: #2ecc71; color: white; padding: 15px 20px; text-align: center; }
  .container { padding: 20px; max-width: 1000px; margin: auto; }
  h1 { color: #2ecc71; }
  .project {
    background: white;
    border-radius: 10px;
    margin-bottom: 20px;
    padding: 15px;
    box-shadow: 0 0 8px rgba(0,0,0,0.1);
    position: relative;
  }
  .project img {
    width: 100%;
    border-radius: 8px;
    max-height: 300px;
    object-fit: cover;
    cursor: pointer;
  }
  .project h2 { color: #2ecc71; margin: 10px 0 5px; }
  .delete-btn {
    position: absolute; top: 10px; right: 10px;
    background: #e74c3c; color: white;
    border: none; padding: 5px 8px; border-radius: 5px; cursor: pointer;
  }
  .delete-btn:hover { background: #c0392b; }
  .add-btn, .save-btn {
    display: block; background: #27ae60; color: white;
    text-align: center; padding: 10px; border-radius: 8px;
    cursor: pointer; margin-top: 20px;
  }
  .add-btn:hover, .save-btn:hover { background: #219150; }
  .back {
    margin-top: 20px; display: inline-block;
    background: #2ecc71; color: white; padding: 10px 20px;
    border-radius: 5px; text-decoration: none;
  }
  .back:hover { background: #27ae60; }
</style>
</head>
<body>

<header>
  <h1 contenteditable="true">Recent Projects ‚Äì KIBSVIC LIMITED</h1>
</header>

<div class="container" id="projectContainer"></div>

<div class="container">
  <div class="add-btn" onclick="addProject()">+ Add New Project</div>
  <div class="save-btn" onclick="saveProjects()">üíæ Save Changes</div>
  <a class="back" href="index.html">‚Üê Back to Home</a>
</div>

<footer contenteditable="true">
  &copy; 2025 KIBSVIC LIMITED
</footer>

<!-- Firebase SDKs -->
<script type="module">
  // --- Import Firebase modules ---
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getFirestore, collection, getDocs, setDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js";

  // --- Your Firebase config ---
  const firebaseConfig = {
    apiKey: "AIzaSyDjUIP2d_94uVS825WCZwW7Bn_InazB4to",
    authDomain: "kibsvic-48ba2.firebaseapp.com",
    projectId: "kibsvic-48ba2",
    storageBucket: "kibsvic-48ba2.firebasestorage.app",
    messagingSenderId: "805273446777",
    appId: "1:805273446777:web:97ee092666e66d06b227a8",
    measurementId: "G-0TWM73M8M8"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // Load projects when page opens
  window.onload = async function() {
    await loadProjects();
  };

  async function addProject() {
    const container = document.getElementById("projectContainer");
    const div = document.createElement("div");
    div.className = "project";

    const delBtn = document.createElement("button");
    delBtn.className = "delete-btn";
    delBtn.innerText = "‚úñ";
    delBtn.onclick = () => { div.remove(); };

    const img = document.createElement("img");
    img.src = "placeholder.jpg";
    img.onclick = () => changeImage(img);

    const h2 = document.createElement("h2");
    h2.contentEditable = "true";
    h2.innerText = "New Project Title";

    const p = document.createElement("p");
    p.contentEditable = "true";
    p.innerText = "Project details go here...";

    div.append(delBtn, img, h2, p);
    container.appendChild(div);
    alert("‚úÖ Added new project. Edit and click 'Save Changes'.");
  }

  async function changeImage(img) {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "image/*";
    input.onchange = async e => {
      const file = e.target.files[0];
      if (!file) return;

      try {
        const storageRef = ref(storage, "projects/" + file.name);
        await uploadBytes(storageRef, file);
        const url = await getDownloadURL(storageRef);
        img.src = url;
        img.dataset.imageUrl = url;
        alert("‚úÖ Image uploaded successfully!");
      } catch (err) {
        console.error("Upload error:", err);
        alert("‚ùå Failed to upload image");
      }
    };
    input.click();
  }

  async function saveProjects() {
    const projects = document.querySelectorAll(".project");
    const collectionRef = collection(db, "projects");

    for (let i = 0; i < projects.length; i++) {
      const p = projects[i];
      const img = p.querySelector("img").dataset.imageUrl || p.querySelector("img").src;
      const title = p.querySelector("h2").innerText;
      const desc = p.querySelector("p").innerText;

      await setDoc(doc(collectionRef, "project_" + i), {
        title,
        desc,
        img
      });
    }

    alert("‚úÖ All projects saved online to Firebase!");
  }

  async function loadProjects() {
    const snapshot = await getDocs(collection(db, "projects"));
    const projects = [];
    snapshot.forEach(docSnap => {
      projects.push(docSnap.data());
    });
    displayProjects(projects);
  }

  function displayProjects(projects) {
    const container = document.getElementById("projectContainer");
    container.innerHTML = "";
    projects.forEach(proj => {
      const div = document.createElement("div");
      div.className = "project";

      const delBtn = document.createElement("button");
      delBtn.className = "delete-btn";
      delBtn.innerText = "‚úñ";
      delBtn.onclick = async () => {
        await deleteDoc(doc(db, "projects", "project_" + proj.title));
        div.remove();
      };

      const img = document.createElement("img");
      img.src = proj.img || "placeholder.jpg";
      img.onclick = () => changeImage(img);

      const h2 = document.createElement("h2");
      h2.contentEditable = "true";
      h2.innerText = proj.title;

      const p = document.createElement("p");
      p.contentEditable = "true";
      p.innerText = proj.desc;

      div.append(delBtn, img, h2, p);
      container.appendChild(div);
    });
  }
</script>

</body>
</html>
