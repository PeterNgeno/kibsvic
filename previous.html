<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Recent Constructions ‚Äì KIBSVIC LIMITED</title>
  <style>
    body { font-family: Arial; background: #f2f2f2; margin: 0; padding: 0; color: #333; }
    header, footer { background-color: #2ecc71; color: white; padding: 15px 20px; text-align: center; }
    .container { padding: 20px; max-width: 1000px; margin: auto; }
    h1 { color: #2ecc71; }
    .project {
      background: white;
      border-radius: 10px;
      margin-bottom: 20px;
      padding: 15px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }
    .project img {
      width: 100%;
      border-radius: 8px;
      max-height: 300px;
      object-fit: cover;
      cursor: pointer;
    }
    .project h2, .project p {
      margin: 10px 0 5px;
    }
    .back {
      margin-top: 20px;
      display: inline-block;
      background: #2ecc71;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      text-decoration: none;
    }
    .back:hover {
      background: #27ae60;
    }
    .add-btn {
      display: block;
      background: #27ae60;
      color: white;
      text-align: center;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 20px;
    }
    .add-btn:hover {
      background: #219150;
    }
    .save-btn {
      display: block;
      background: #1e88e5;
      color: white;
      text-align: center;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 10px;
    }
    .save-btn:hover {
      background: #1565c0;
    }
    .status {
      margin-top: 8px;
      font-size: 14px;
      color: #444;
    }
    .project-controls {
      display:flex;
      gap:8px;
      margin-top:8px;
    }
    .delete-btn {
      background: #e53935;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      cursor:pointer;
    }
    .delete-btn:hover { background: #c62828; }
  </style>
</head>
<body>

<header>
  <!-- header is editable & will be saved -->
  <h1 id="pageTitle" contenteditable="true">Recent Projects ‚Äì KIBSVIC LIMITED</h1>
</header>

<div class="container" id="projectContainer"></div>

<div class="container">
  <div class="add-btn" id="addBtn">+ Add New Project</div>
  <div class="save-btn" id="saveBtn">üíæ Save Updates</div>
  <div class="status" id="statusMsg"></div>
  <a class="back" href="index.html">‚Üê Back to Home</a>
</div>

<footer>
  <!-- footer editable & will be saved -->
  <div id="pageFooter" contenteditable="true" style="padding:10px 20px; text-align:center;">
    &copy; 2025 KIBSVIC LIMITED
  </div>
</footer>

<script>
(function(){
  const projectContainer = document.getElementById('projectContainer');
  const saveBtn = document.getElementById('saveBtn');
  const addBtn = document.getElementById('addBtn');
  const statusMsg = document.getElementById('statusMsg');
  const pageTitle = document.getElementById('pageTitle');
  const pageFooter = document.getElementById('pageFooter');

  // Utility: check localStorage available
  function storageAvailable() {
    try {
      const testKey = '__ls_test__';
      localStorage.setItem(testKey, testKey);
      localStorage.removeItem(testKey);
      return true;
    } catch (e) {
      return false;
    }
  }

  function showStatus(msg, ok = true) {
    statusMsg.textContent = msg;
    statusMsg.style.color = ok ? '#2e7d32' : '#c62828';
    if (ok) {
      // fade out after 2.5s
      setTimeout(() => { if (statusMsg.textContent === msg) statusMsg.textContent = ''; }, 2500);
    }
  }

  // Load projects + header/footer from localStorage
  function loadProjects() {
    projectContainer.innerHTML = '';
    if (!storageAvailable()) {
      showStatus('localStorage not available ‚Äî changes will not persist.', false);
      return;
    }
    try {
      const saved = JSON.parse(localStorage.getItem('projects')) || [];
      const savedTitle = localStorage.getItem('projects_pageTitle');
      const savedFooter = localStorage.getItem('projects_pageFooter');

      if (savedTitle) pageTitle.innerText = savedTitle;
      if (savedFooter) pageFooter.innerText = savedFooter;

      if (saved.length === 0) {
        // optionally show nothing
      }

      saved.forEach((p, idx) => {
        projectContainer.appendChild(createProjectCard(p.img, p.title, p.desc, idx));
      });
    } catch (err) {
      console.error('Load error', err);
      showStatus('Failed to load saved data (console).', false);
    }
  }

  // Create a project DOM card (with delete control)
  function createProjectCard(imgSrc, title, desc, index) {
    const div = document.createElement('div');
    div.className = 'project';

    const img = document.createElement('img');
    img.src = imgSrc || 'placeholder.jpg';
    img.alt = 'Project Image';
    img.title = 'Click to replace image';
    img.style.display = 'block';
    img.addEventListener('click', () => replaceImage(img));

    const h2 = document.createElement('h2');
    h2.contentEditable = 'true';
    h2.innerText = title || 'New Project Title';

    const p = document.createElement('p');
    p.contentEditable = 'true';
    p.innerText = desc || 'Project details go here...';

    // delete button to remove a project
    const controls = document.createElement('div');
    controls.className = 'project-controls';
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'delete-btn';
    deleteBtn.textContent = 'Delete';
    deleteBtn.addEventListener('click', () => {
      if (confirm('Delete this project?')) {
        div.remove();
        // save after delete to persist change
        saveProjects();
      }
    });
    controls.appendChild(deleteBtn);

    // Save on input events for immediate persistence
    h2.addEventListener('input', saveProjectsDebounced);
    p.addEventListener('input', saveProjectsDebounced);

    div.appendChild(img);
    div.appendChild(h2);
    div.appendChild(p);
    div.appendChild(controls);

    return div;
  }

  // Debounce save to avoid too many writes while typing
  let debounceTimer = null;
  function saveProjectsDebounced() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => saveProjects(), 400);
  }

  // Replace image -> read as dataURL -> set src -> save and reload from storage to ensure persistence
  function replaceImage(imgEl) {
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = 'image/*';
    fileInput.addEventListener('change', (ev) => {
      const file = ev.target.files && ev.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        // set image src to dataURL
        imgEl.src = e.target.result;
        // save immediately, then reload UI from storage (ensures nothing stale remains)
        saveProjects();
        // reload to force canonical saved state (use setTimeout so disk writes finish)
        setTimeout(loadProjects, 150);
      };
      reader.readAsDataURL(file);
    });
    fileInput.click();
  }

  // Collect and save all data (projects, header, footer)
  function saveProjects() {
    if (!storageAvailable()) {
      showStatus('Cannot save ‚Äî localStorage unavailable.', false);
      return;
    }
    try {
      const projects = [];
      document.querySelectorAll('.project').forEach(card => {
        const img = card.querySelector('img');
        const h2 = card.querySelector('h2');
        const p = card.querySelector('p');
        projects.push({
          img: img ? img.src : 'placeholder.jpg',
          title: h2 ? h2.innerText.trim() : '',
          desc: p ? p.innerText.trim() : ''
        });
      });
      localStorage.setItem('projects', JSON.stringify(projects));
      localStorage.setItem('projects_pageTitle', pageTitle.innerText.trim());
      localStorage.setItem('projects_pageFooter', pageFooter.innerText.trim());
      showStatus('Saved ‚úì', true);
      console.log('Saved', projects.length, 'projects');
    } catch (err) {
      console.error('Save error', err);
      showStatus('Error saving data (console).', false);
    }
  }

  // Add a new project card and focus its title
  function addProject() {
    const newCard = createProjectCard('placeholder.jpg', 'New Project Title', 'Project details go here...', Date.now());
    projectContainer.appendChild(newCard);
    // bring focus to new project's title for quick edit
    const newTitle = newCard.querySelector('h2');
    newTitle.focus();
    saveProjects();
  }

  // Hook up UI buttons
  addBtn.addEventListener('click', addProject);
  saveBtn.addEventListener('click', () => {
    saveProjects();
    // reload to reflect canonical saved state
    setTimeout(loadProjects, 120);
  });

  // Save on beforeunload as a last attempt
  window.addEventListener('beforeunload', () => saveProjects());

  // Initial load
  loadProjects();
})();
</script>

</body>
</html>
